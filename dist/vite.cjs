"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const P=require("fs"),$=require("path");function _(n){const c=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(n){for(const r in n)if(r!=="default"){const f=Object.getOwnPropertyDescriptor(n,r);Object.defineProperty(c,r,f.get?f:{enumerable:!0,get:()=>n[r]})}}return c.default=n,Object.freeze(c)}const d=_(P),g=_($);function A(n){const c=new Map;try{if(!d.existsSync(n))return console.warn(`[vue-dev-inspector] Analysis file not found: ${n}`),c;const r=JSON.parse(d.readFileSync(n,"utf-8"));for(const[,f]of Object.entries(r.components))for(const y of f.elements)if(y.binding&&y.db){const h=y.binding.replace(/^\./,"");c.has(h)||c.set(h,y.db)}console.log(`[vue-dev-inspector] Loaded ${c.size} binding->DB mappings from analysis`)}catch(r){console.warn("[vue-dev-inspector] Failed to load analysis file:",r)}return c}function j(n,c,r){let f=n;const y=/\{\{\s*([^{}]+?)\s*\}\}/g,h=[];let i;for(;(i=y.exec(n))!==null;){const m=i[0],u=i[1].trim();if(n.slice(Math.max(0,i.index-100),i.index).includes("data-di-binding")||u.includes("?")&&u.includes(":")||u.includes("|"))continue;let e=u.replace(/\?\.?/g,".").replace(/\s+/g,"").replace(/^\(|\)$/g,"");const S=e.match(/^\w+\(([^)]+)\)$/);S&&(e=S[1]);let a=`data-di-binding="${e}"`;a+=` data-di-component="${r}"`;let l=c.get(e);if(!l&&e.includes(".")){const t=e.split(".").pop();for(const[v,p]of c.entries())if(v.endsWith("."+t)||v===t){l=p;break}}l&&(a+=` data-di-db="${l.table}.${l.column}"`,l.type&&(a+=` data-di-db-type="${l.type}"`),l.comment&&(a+=` data-di-db-comment="${l.comment.replace(/"/g,"&quot;")}"`));const o=`<span ${a}>${m}</span>`;h.push({original:m,replacement:o})}for(const{original:m,replacement:u}of h.reverse())f=f.replace(m,u);return f}function x(n){return g.basename(n,".vue")}function w(n){return!n||n==="/"?"index.json":n.slice(1).replace(/\//g,"_")+".json"}function T(n={}){const{enabled:c=process.env.NODE_ENV!=="production",analysisPath:r,syncDir:f="./dev-inspector-annotations",exclude:y=["node_modules/**","**/node_modules/**"]}=n;let h=new Map,i="";const m=new Set;return{name:"vite-plugin-dev-inspector",enforce:"pre",configResolved(){if(!c){console.log("[vue-dev-inspector] Plugin disabled");return}if(console.log("[vue-dev-inspector] Plugin enabled"),i=g.isAbsolute(f)?f:g.resolve(process.cwd(),f),r){const u=g.isAbsolute(r)?r:g.resolve(process.cwd(),r);h=A(u)}},configureServer(u){c&&(d.existsSync(i)||d.mkdirSync(i,{recursive:!0}),u.middlewares.use((s,e,S)=>{var l;const a=new URL(s.url||"","http://localhost");if(a.pathname==="/__dev-inspector/annotations"&&s.method==="GET"){e.setHeader("Content-Type","application/json"),e.setHeader("Access-Control-Allow-Origin","*");try{const o=a.searchParams.get("page")||"/",t=g.join(i,w(o));if(d.existsSync(t)){const v=d.readFileSync(t,"utf-8");e.end(v)}else e.end(JSON.stringify({annotations:{},screenConfig:null}))}catch(o){e.statusCode=500,e.end(JSON.stringify({error:String(o)}))}return}if(a.pathname==="/__dev-inspector/annotations"&&s.method==="POST"){let o="";s.on("data",t=>{o+=t}),s.on("end",()=>{e.setHeader("Content-Type","application/json"),e.setHeader("Access-Control-Allow-Origin","*");try{const t=JSON.parse(o),{clientId:v,page:p,...b}=t,C=g.join(i,w(p||"/"));d.existsSync(i)||d.mkdirSync(i,{recursive:!0}),d.writeFileSync(C,JSON.stringify(b,null,2),"utf-8");const O=`data: ${JSON.stringify({type:"update",clientId:v,page:p||"/",...b})}

`;for(const N of m)try{N.write(O)}catch{m.delete(N)}e.end(JSON.stringify({ok:!0})),console.log("[vue-dev-inspector] Annotations synced:",w(p||"/"))}catch(t){e.statusCode=400,e.end(JSON.stringify({error:String(t)}))}});return}if(a.pathname==="/__dev-inspector/masters"&&s.method==="GET"){e.setHeader("Content-Type","application/json"),e.setHeader("Access-Control-Allow-Origin","*");try{const o=g.join(i,"_masters.json");if(d.existsSync(o)){const t=d.readFileSync(o,"utf-8");e.end(t)}else e.end(JSON.stringify({masters:{}}))}catch(o){e.statusCode=500,e.end(JSON.stringify({error:String(o)}))}return}if(a.pathname==="/__dev-inspector/masters"&&s.method==="POST"){let o="";s.on("data",t=>{o+=t}),s.on("end",()=>{e.setHeader("Content-Type","application/json"),e.setHeader("Access-Control-Allow-Origin","*");try{const t=JSON.parse(o),{clientId:v,...p}=t,b=g.join(i,"_masters.json");d.existsSync(i)||d.mkdirSync(i,{recursive:!0}),d.writeFileSync(b,JSON.stringify(p,null,2),"utf-8");const C=`data: ${JSON.stringify({type:"masters",clientId:v,...p})}

`;for(const O of m)try{O.write(C)}catch{m.delete(O)}e.end(JSON.stringify({ok:!0})),console.log("[vue-dev-inspector] Masters synced:",Object.keys(p.masters||{}).length,"definitions")}catch(t){e.statusCode=400,e.end(JSON.stringify({error:String(t)}))}});return}if(a.pathname==="/__dev-inspector/events"&&s.method==="GET"){e.setHeader("Content-Type","text/event-stream"),e.setHeader("Cache-Control","no-cache"),e.setHeader("Connection","keep-alive"),e.setHeader("Access-Control-Allow-Origin","*"),e.flushHeaders(),e.write(`data: {"type":"connected"}

`),m.add(e),s.on("close",()=>{m.delete(e)});return}if((l=s.url)!=null&&l.startsWith("/__dev-inspector/")&&s.method==="OPTIONS"){e.setHeader("Access-Control-Allow-Origin","*"),e.setHeader("Access-Control-Allow-Methods","GET, POST, OPTIONS"),e.setHeader("Access-Control-Allow-Headers","Content-Type"),e.statusCode=204,e.end();return}S()}),console.log("[vue-dev-inspector] Sync server ready (dir:",i+")"))},transform(u,s){if(!c||!s.endsWith(".vue"))return null;console.log(`[vue-dev-inspector] transform called: ${s}`);const e=g.relative(process.cwd(),s);if(y.some(p=>p.includes("**")?e.includes(p.replace("**/","").replace("/**","")):e.startsWith(p)))return null;const a=u.match(/<template[^>]*>([\s\S]*?)<\/template>/i);if(!a)return console.log(`[vue-dev-inspector] No template found in: ${s}`),null;const l=a[1],o=x(s);console.log(`[vue-dev-inspector] Processing template for: ${o}`);const t=j(l,h,o);return t===l?(console.log(`[vue-dev-inspector] No changes for: ${o}`),null):(console.log(`[vue-dev-inspector] Transformed: ${o}`),{code:u.replace(/<template([^>]*)>([\s\S]*?)<\/template>/i,`<template$1>${t}</template>`),map:null})}}}exports.default=T;exports.vitePluginDevInspector=T;
