"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const w=require("fs"),N=require("path");function O(s){const r=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(s){for(const c in s)if(c!=="default"){const l=Object.getOwnPropertyDescriptor(s,c);Object.defineProperty(r,c,l.get?l:{enumerable:!0,get:()=>s[c]})}}return r.default=s,Object.freeze(r)}const a=O(w),m=O(N);function _(s){const r=new Map;try{if(!a.existsSync(s))return console.warn(`[vue-dev-inspector] Analysis file not found: ${s}`),r;const c=JSON.parse(a.readFileSync(s,"utf-8"));for(const[,l]of Object.entries(c.components))for(const v of l.elements)if(v.binding&&v.db){const y=v.binding.replace(/^\./,"");r.has(y)||r.set(y,v.db)}console.log(`[vue-dev-inspector] Loaded ${r.size} binding->DB mappings from analysis`)}catch(c){console.warn("[vue-dev-inspector] Failed to load analysis file:",c)}return r}function P(s,r,c){let l=s;const v=/\{\{\s*([^{}]+?)\s*\}\}/g,y=[];let i;for(;(i=v.exec(s))!==null;){const d=i[0],n=i[1].trim();if(s.slice(Math.max(0,i.index-100),i.index).includes("data-di-binding")||n.includes("?")&&n.includes(":")||n.includes("|"))continue;let g=n.replace(/\?\.?/g,".").replace(/\s+/g,"").replace(/^\(|\)$/g,"");const u=g.match(/^\w+\(([^)]+)\)$/);u&&(g=u[1]);let p=`data-di-binding="${g}"`;p+=` data-di-component="${c}"`;let t=r.get(g);if(!t&&g.includes(".")){const f=g.split(".").pop();for(const[S,h]of r.entries())if(S.endsWith("."+f)||S===f){t=h;break}}t&&(p+=` data-di-db="${t.table}.${t.column}"`,t.type&&(p+=` data-di-db-type="${t.type}"`),t.comment&&(p+=` data-di-db-comment="${t.comment.replace(/"/g,"&quot;")}"`));const o=`<span ${p}>${d}</span>`;y.push({original:d,replacement:o})}for(const{original:d,replacement:n}of y.reverse())l=l.split(d).join(n);return l}function T(s){return m.basename(s,".vue")}function b(s){return!s||s==="/"?"index.json":s.slice(1).replace(/\//g,"_")+".json"}function C(s={}){const{enabled:r=process.env.NODE_ENV!=="production",analysisPath:c,syncDir:l="./dev-inspector-annotations",exclude:v=["node_modules/**","**/node_modules/**"]}=s;let y=new Map,i="";return{name:"vite-plugin-dev-inspector",enforce:"pre",configResolved(){if(!r){console.log("[vue-dev-inspector] Plugin disabled");return}if(console.log("[vue-dev-inspector] Plugin enabled"),i=m.isAbsolute(l)?l:m.resolve(process.cwd(),l),c){const d=m.isAbsolute(c)?c:m.resolve(process.cwd(),c);y=_(d)}},configureServer(d){r&&(a.existsSync(i)||a.mkdirSync(i,{recursive:!0}),d.middlewares.use((n,e,g)=>{var p;const u=new URL(n.url||"","http://localhost");if(u.pathname==="/__dev-inspector/annotations"&&n.method==="GET"){e.setHeader("Content-Type","application/json"),e.setHeader("Access-Control-Allow-Origin","*");try{const t=u.searchParams.get("page")||"/",o=m.join(i,b(t));if(a.existsSync(o)){const f=a.readFileSync(o,"utf-8");e.end(f)}else e.end(JSON.stringify({annotations:{},screenConfig:null}))}catch(t){e.statusCode=500,e.end(JSON.stringify({error:String(t)}))}return}if(u.pathname==="/__dev-inspector/annotations"&&n.method==="POST"){let t="";n.on("data",o=>{t+=o}),n.on("end",()=>{e.setHeader("Content-Type","application/json"),e.setHeader("Access-Control-Allow-Origin","*");try{const o=JSON.parse(t),{page:f,...S}=o,h=m.join(i,b(f||"/"));a.existsSync(i)||a.mkdirSync(i,{recursive:!0}),a.writeFileSync(h,JSON.stringify(S,null,2),"utf-8"),e.end(JSON.stringify({ok:!0})),console.log("[vue-dev-inspector] Annotations saved:",b(f||"/"))}catch(o){e.statusCode=400,e.end(JSON.stringify({error:String(o)}))}});return}if(u.pathname==="/__dev-inspector/masters"&&n.method==="GET"){e.setHeader("Content-Type","application/json"),e.setHeader("Access-Control-Allow-Origin","*");try{const t=m.join(i,"_masters.json");if(a.existsSync(t)){const o=a.readFileSync(t,"utf-8");e.end(o)}else e.end(JSON.stringify({masters:{}}))}catch(t){e.statusCode=500,e.end(JSON.stringify({error:String(t)}))}return}if(u.pathname==="/__dev-inspector/masters"&&n.method==="POST"){let t="";n.on("data",o=>{t+=o}),n.on("end",()=>{e.setHeader("Content-Type","application/json"),e.setHeader("Access-Control-Allow-Origin","*");try{const o=JSON.parse(t),f=m.join(i,"_masters.json");a.existsSync(i)||a.mkdirSync(i,{recursive:!0}),a.writeFileSync(f,JSON.stringify(o,null,2),"utf-8"),e.end(JSON.stringify({ok:!0})),console.log("[vue-dev-inspector] Masters saved:",Object.keys(o.masters||{}).length,"definitions")}catch(o){e.statusCode=400,e.end(JSON.stringify({error:String(o)}))}});return}if((p=n.url)!=null&&p.startsWith("/__dev-inspector/")&&n.method==="OPTIONS"){e.setHeader("Access-Control-Allow-Origin","*"),e.setHeader("Access-Control-Allow-Methods","GET, POST, OPTIONS"),e.setHeader("Access-Control-Allow-Headers","Content-Type"),e.statusCode=204,e.end();return}g()}),console.log("[vue-dev-inspector] Sync server ready (dir:",i+")"))},transform(d,n){if(!r||!n.endsWith(".vue"))return null;console.log(`[vue-dev-inspector] transform called: ${n}`);const e=m.relative(process.cwd(),n);if(v.some(S=>S.includes("**")?e.includes(S.replace("**/","").replace("/**","")):e.startsWith(S)))return null;const u=d.match(/<template[^>]*>([\s\S]*?)<\/template>/i);if(!u)return console.log(`[vue-dev-inspector] No template found in: ${n}`),null;const p=u[1],t=T(n);console.log(`[vue-dev-inspector] Processing template for: ${t}`);const o=P(p,y,t);return o===p?(console.log(`[vue-dev-inspector] No changes for: ${t}`),null):(console.log(`[vue-dev-inspector] Transformed: ${t}`),{code:d.replace(/<template([^>]*)>([\s\S]*?)<\/template>/i,`<template$1>${o}</template>`),map:null})}}}exports.default=C;exports.vitePluginDevInspector=C;
