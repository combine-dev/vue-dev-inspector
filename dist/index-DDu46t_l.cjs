"use strict";const N=require("unplugin"),P=require("fs"),j=require("path");function x(t){const n=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(t){for(const e in t)if(e!=="default"){const l=Object.getOwnPropertyDescriptor(t,e);Object.defineProperty(n,e,l.get?l:{enumerable:!0,get:()=>t[e]})}}return n.default=t,Object.freeze(n)}const d=x(P),f=x(j);function C(t){const n=new Map;try{if(!d.existsSync(t))return console.warn(`[vue-dev-inspector] Analysis file not found: ${t}`),n;const e=JSON.parse(d.readFileSync(t,"utf-8"));for(const[,l]of Object.entries(e.components))for(const o of l.elements)if(o.binding&&o.db){const c=o.binding.replace(/^\./,"");n.has(c)||n.set(c,o.db)}console.log(`[vue-dev-inspector] Loaded ${n.size} binding->DB mappings from analysis`)}catch(e){console.warn("[vue-dev-inspector] Failed to load analysis file:",e)}return n}function b(t){return f.basename(t,f.extname(t))}function v(t){return!t||t==="/"?"index.json":t.slice(1).replace(/\//g,"_")+".json"}function T(t,n,e){let l=t;const o=/\{\{\s*([^{}]+?)\s*\}\}/g,c=[];let i;for(;(i=o.exec(t))!==null;){const s=i[0],u=i[1].trim();if(t.slice(Math.max(0,i.index-100),i.index).includes("data-di-binding")||u.includes("?")&&u.includes(":")||u.includes("|"))continue;let m=u.replace(/\?\.?/g,".").replace(/\s+/g,"").replace(/^\(|\)$/g,"");const a=m.match(/^\w+\(([^)]+)\)$/);a&&(m=a[1]);let p=`data-di-binding="${m}"`;p+=` data-di-component="${e}"`;let r=n.get(m);if(!r&&m.includes(".")){const S=m.split(".").pop();for(const[y,O]of n.entries())if(y.endsWith("."+S)||y===S){r=O;break}}r&&(p+=` data-di-db="${r.table}.${r.column}"`,r.type&&(p+=` data-di-db-type="${r.type}"`),r.comment&&(p+=` data-di-db-comment="${r.comment.replace(/"/g,"&quot;")}"`));const g=`<span ${p}>${s}</span>`;c.push({original:s,replacement:g})}for(const{original:s,replacement:u}of c.reverse())l=l.split(s).join(u);return l}function A(t,n,e){const l=new RegExp("(?<=>[\\s\\n]*)\\{(\\s*[\\w$]+(?:\\.[\\w$]+|\\?\\.\\w+)+\\s*)\\}(?=[\\s\\n]*<)","g"),o=[];let c;for(;(c=l.exec(t))!==null;){const s=c[0],u=c[1].trim();if(t.slice(Math.max(0,c.index-100),c.index).includes("data-di-binding")||/^(styles|style|css|className|children)\./.test(u))continue;const m=u.split(".").pop()||"";if(/^(map|filter|reduce|forEach|find|some|every|sort|slice|length|keys|values|entries|join|includes|indexOf|flat|flatMap)$/.test(m))continue;let a=u.replace(/\?\.?/g,".").replace(/\s+/g,""),p=`data-di-binding="${a}"`;p+=` data-di-component="${e}"`;let r=n.get(a);if(!r&&a.includes(".")){const S=a.split(".").pop();for(const[y,O]of n.entries())if(y.endsWith("."+S)||y===S){r=O;break}}r&&(p+=` data-di-db="${r.table}.${r.column}"`,r.type&&(p+=` data-di-db-type="${r.type}"`),r.comment&&(p+=` data-di-db-comment="${r.comment.replace(/"/g,"&quot;")}"`));const g=`<span ${p}>${s}</span>`;o.push({index:c.index,length:s.length,original:s,replacement:g})}if(o.length===0)return t;let i=t;for(const{index:s,length:u,replacement:h}of o.reverse())i=i.slice(0,s)+h+i.slice(s+u);return i}function $(t){return(n,e,l)=>{var c;const o=new URL(n.url||"","http://localhost");if(o.pathname==="/__dev-inspector/annotations"&&n.method==="GET"){e.setHeader("Content-Type","application/json"),e.setHeader("Access-Control-Allow-Origin","*");try{const i=o.searchParams.get("page")||"/",s=f.join(t,v(i));if(d.existsSync(s)){const u=d.readFileSync(s,"utf-8");e.end(u)}else e.end(JSON.stringify({annotations:{},screenConfig:null}))}catch(i){e.statusCode=500,e.end(JSON.stringify({error:String(i)}))}return}if(o.pathname==="/__dev-inspector/annotations"&&n.method==="POST"){let i="";n.on("data",s=>{i+=s}),n.on("end",()=>{e.setHeader("Content-Type","application/json"),e.setHeader("Access-Control-Allow-Origin","*");try{const s=JSON.parse(i),{page:u,...h}=s,m=f.join(t,v(u||"/"));d.existsSync(t)||d.mkdirSync(t,{recursive:!0}),d.writeFileSync(m,JSON.stringify(h,null,2),"utf-8"),e.end(JSON.stringify({ok:!0})),console.log("[vue-dev-inspector] Annotations saved:",v(u||"/"))}catch(s){e.statusCode=400,e.end(JSON.stringify({error:String(s)}))}});return}if(o.pathname==="/__dev-inspector/masters"&&n.method==="GET"){e.setHeader("Content-Type","application/json"),e.setHeader("Access-Control-Allow-Origin","*");try{const i=f.join(t,"_masters.json");if(d.existsSync(i)){const s=d.readFileSync(i,"utf-8");e.end(s)}else e.end(JSON.stringify({masters:{}}))}catch(i){e.statusCode=500,e.end(JSON.stringify({error:String(i)}))}return}if(o.pathname==="/__dev-inspector/masters"&&n.method==="POST"){let i="";n.on("data",s=>{i+=s}),n.on("end",()=>{e.setHeader("Content-Type","application/json"),e.setHeader("Access-Control-Allow-Origin","*");try{const s=JSON.parse(i),u=f.join(t,"_masters.json");d.existsSync(t)||d.mkdirSync(t,{recursive:!0}),d.writeFileSync(u,JSON.stringify(s,null,2),"utf-8"),e.end(JSON.stringify({ok:!0})),console.log("[vue-dev-inspector] Masters saved:",Object.keys(s.masters||{}).length,"definitions")}catch(s){e.statusCode=400,e.end(JSON.stringify({error:String(s)}))}});return}if((c=n.url)!=null&&c.startsWith("/__dev-inspector/")&&n.method==="OPTIONS"){e.setHeader("Access-Control-Allow-Origin","*"),e.setHeader("Access-Control-Allow-Methods","GET, POST, OPTIONS"),e.setHeader("Access-Control-Allow-Headers","Content-Type"),e.statusCode=204,e.end();return}l()}}async function J(t,n){const e=new URL(t.url),l={"Content-Type":"application/json","Access-Control-Allow-Origin":"*"};if(e.pathname.endsWith("/annotations")&&t.method==="GET")try{const o=e.searchParams.get("page")||"/",c=f.join(n,v(o));if(d.existsSync(c)){const i=d.readFileSync(c,"utf-8");return new Response(i,{headers:l})}return new Response(JSON.stringify({annotations:{},screenConfig:null}),{headers:l})}catch(o){return new Response(JSON.stringify({error:String(o)}),{status:500,headers:l})}if(e.pathname.endsWith("/annotations")&&t.method==="POST")try{const o=await t.json(),{page:c,...i}=o,s=f.join(n,v(c||"/"));return d.existsSync(n)||d.mkdirSync(n,{recursive:!0}),d.writeFileSync(s,JSON.stringify(i,null,2),"utf-8"),console.log("[vue-dev-inspector] Annotations saved:",v(c||"/")),new Response(JSON.stringify({ok:!0}),{headers:l})}catch(o){return new Response(JSON.stringify({error:String(o)}),{status:400,headers:l})}if(e.pathname.endsWith("/masters")&&t.method==="GET")try{const o=f.join(n,"_masters.json");if(d.existsSync(o)){const c=d.readFileSync(o,"utf-8");return new Response(c,{headers:l})}return new Response(JSON.stringify({masters:{}}),{headers:l})}catch(o){return new Response(JSON.stringify({error:String(o)}),{status:500,headers:l})}if(e.pathname.endsWith("/masters")&&t.method==="POST")try{const o=await t.json(),c=f.join(n,"_masters.json");return d.existsSync(n)||d.mkdirSync(n,{recursive:!0}),d.writeFileSync(c,JSON.stringify(o,null,2),"utf-8"),console.log("[vue-dev-inspector] Masters saved:",Object.keys(o.masters||{}).length,"definitions"),new Response(JSON.stringify({ok:!0}),{headers:l})}catch(o){return new Response(JSON.stringify({error:String(o)}),{status:400,headers:l})}return t.method==="OPTIONS"?new Response(null,{status:204,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}}):null}const w=N.createUnplugin((t={})=>{const{enabled:n=process.env.NODE_ENV!=="production",analysisPath:e,syncDir:l="./dev-inspector-annotations",exclude:o=["node_modules/**","**/node_modules/**"],include:c}=t;let i=new Map,s="";function u(){if(!s&&(s=f.isAbsolute(l)?l:f.resolve(process.cwd(),l),e)){const a=f.isAbsolute(e)?e:f.resolve(process.cwd(),e);i=C(a)}}function h(a){const p=f.relative(process.cwd(),a);return o.some(r=>r.includes("**")?p.includes(r.replace("**/","").replace("/**","")):p.startsWith(r))}function m(a){if(!c)return!0;const p=f.relative(process.cwd(),a);return c.some(r=>{if(r.includes("**")){const g=r.replace("**/","").replace("/**","");return p.endsWith(g)||p.includes(g)}return p.endsWith(r)})}return[{name:"dev-inspector-vue-transform",enforce:"pre",transformInclude(a){return n?a.endsWith(".vue")&&!h(a)&&m(a):!1},transform(a,p){u();const r=a.match(/<template[^>]*>([\s\S]*?)<\/template>/i);if(!r)return null;const g=r[1],S=b(p),y=T(g,i,S);return y===g?null:{code:a.replace(/<template([^>]*)>([\s\S]*?)<\/template>/i,`<template$1>${y}</template>`),map:null}},vite:{configResolved(){if(!n){console.log("[vue-dev-inspector] Plugin disabled");return}console.log("[vue-dev-inspector] Plugin enabled"),u()}}},{name:"dev-inspector-jsx-transform",enforce:"pre",transformInclude(a){return n?/\.[jt]sx$/.test(a)&&!h(a)&&m(a):!1},transform(a,p){u();const r=b(p),g=A(a,i,r);return g===a?null:{code:g,map:null}}},{name:"dev-inspector-server",vite:{configureServer(a){n&&(u(),d.existsSync(s)||d.mkdirSync(s,{recursive:!0}),a.middlewares.use($(s)),console.log("[vue-dev-inspector] Sync server ready (dir:",s+")"))}},webpack(a){n&&(u(),d.existsSync(s)||d.mkdirSync(s,{recursive:!0}),console.log("[vue-dev-inspector] Webpack plugin initialized (syncDir:",s+")"))}}]}),k=w.vite,_=w.webpack;exports.handleFetchRequest=J;exports.unpluginDevInspector=w;exports.vitePlugin=k;exports.webpackPlugin=_;
