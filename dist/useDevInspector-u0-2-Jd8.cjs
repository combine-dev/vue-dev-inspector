"use strict";const r=require("vue"),qe=require("pinia");var J=typeof document<"u"?document.currentScript:null;const ze={},Je="devInspector:elementConfigs",ae=qe.defineStore("devInspector",()=>{const $=r.ref({}),I=r.ref(!1),w=r.ref(!1),O=r.ref(!1),B=r.ref(!1),j=r.ref(null),D=r.ref(!1),f=r.ref({}),L=r.ref(null),F=r.ref(null),M=r.computed(()=>$.value.storageKey||Je),p=r.ref(null),se=r.ref("all"),E=r.ref(new Set),q="devInspector:hiddenAnalysisSelectors",k=r.computed(()=>$.value.enabledInProduction?!0:typeof{url:typeof document>"u"?require("url").pathToFileURL(__filename).href:J&&J.tagName.toUpperCase()==="SCRIPT"&&J.src||new URL("useDevInspector-u0-2-Jd8.cjs",document.baseURI).href}<"u"&&ze?!1:process.env.NODE_ENV==="development"),W=r.ref(!1);function ie(e={}){$.value=e,re(),Ie(),e.analysisData&&(p.value=e.analysisData);const n=e.analysisDataUrl??"/dev-inspector-analysis.json";e.autoLoadAnalysis!==!1&&k.value&&H(n)}async function H(e){var n;try{const t=await fetch(e);if(t.ok)return p.value=await t.json(),console.log("[DevInspector] Analysis data loaded:",Object.keys(((n=p.value)==null?void 0:n.components)||{}).length,"components"),!0}catch{console.debug("[DevInspector] Analysis data not found at",e)}return!1}function ce(e){if(!p.value)return null;for(const n of Object.values(p.value.components)){const t=n.elements.find(o=>o.selector===e);if(t)return t}return null}function le(e){if(!p.value)return[];const n=[];for(const[t,o]of Object.entries(p.value.components))(!e||t.includes(e))&&n.push(...o.elements);return n}function re(){try{const e=$.value.initialAnnotations||{};if(typeof window<"u"){const n=localStorage.getItem(M.value),t=n?JSON.parse(n):{};f.value={...e,...t}}else f.value=e}catch(e){console.error("[DevInspector] Failed to load configs:",e)}}function U(){try{if(typeof window<"u"){const e=JSON.stringify(f.value);localStorage.setItem(M.value,e),console.log("[DevInspector] Saved configs:",Object.keys(f.value).length,"items")}}catch(e){console.error("[DevInspector] Failed to save configs:",e)}}r.watch(f,()=>{r.nextTick(()=>{U()})},{deep:!0});async function ue(){k.value&&(I.value?(I.value=!1,w.value=!1,L.value=null):await X())}async function X(){if(!k.value)return;if(p.value&&!W.value&&$.value.autoApplyAnalysis!==!1){B.value=!0,I.value=!0;try{await new Promise(n=>setTimeout(n,300)),Q(),W.value=!0}finally{B.value=!1}}else I.value=!0}function de(){I.value=!1,w.value=!1,L.value=null}function fe(){w.value=!w.value,w.value||(L.value=null),w.value&&(O.value=!1)}function pe(){O.value=!O.value,O.value&&(w.value=!1),F.value=null}function me(e){F.value=e}function P(e){if(e.id)return`#${e.id}`;if(e.dataset.devId)return`[data-dev-id="${e.dataset.devId}"]`;const n=[];let t=e;for(;t&&t!==document.body;){let o=t.tagName.toLowerCase();if(t.id){o=`#${t.id}`,n.unshift(o);break}const s=Array.from(t.classList).filter(a=>!a.startsWith("hover:")&&!a.startsWith("focus:")).slice(0,2);s.length>0&&(o+="."+s.join("."));const i=t.parentElement;if(i){const a=Array.from(i.children).filter(c=>c.tagName===t.tagName);if(a.length>1){const c=a.indexOf(t)+1;o+=`:nth-child(${c})`}}n.unshift(o),t=t.parentElement}return n.join(" > ")}function ge(){const e=typeof window<"u"?window.location.pathname:"/";return Object.keys(f.value).filter(n=>{const t=f.value[n];return t?(n.includes(">")||n.startsWith("#")||n.startsWith("[")||n.startsWith("."))&&(!t.componentPath||t.componentPath.includes(e)||e==="/"):!1})}function ve(e){j.value=e}function he(){j.value=null}function ye(){D.value=!D.value}function be(){D.value=!0}function Se(){D.value=!1}function Ce(e){return f.value[e]}function Z(e,n){var i;const t=new Date().toISOString(),o=f.value[e],s={...o,...n,id:e,componentPath:n.componentPath||((i=j.value)==null?void 0:i.componentPath)||"",createdAt:(o==null?void 0:o.createdAt)||t,updatedAt:t};f.value={...f.value,[e]:s},r.nextTick(()=>U())}function we(e){const{[e]:n,...t}=f.value;f.value=t,r.nextTick(()=>U())}function K(e){var N;const n=((N=e.textContent)==null?void 0:N.trim())||"",t=e.tagName.toUpperCase();if(!n&&t!=="INPUT"&&t!=="SELECT"&&t!=="TEXTAREA")return null;const o=e.__vueParentComponent;if(o){const v=o.props||{},d=o.attrs||{};if("modelValue"in v||"model-value"in d)return{type:"v-model",source:"form binding detected",isStatic:!1}}if(t==="INPUT"||t==="SELECT"||t==="TEXTAREA"){const v=e.type||"text",d=e.placeholder||"";return{type:"v-model",source:`${t.toLowerCase()}[type=${v}]${d?` placeholder="${d}"`:""}`,isStatic:!1}}const s=e.dataset.source||e.dataset.field||e.dataset.bind;if(s)return{type:"prop",source:s,isStatic:!1};if(e.closest("tbody")||e.closest('[role="rowgroup"]'))return{type:"api",source:"table data",isStatic:!1};const i=e.closest('ul, ol, [role="list"]');if(i&&i.children.length>1)return{type:"api",source:"list item",isStatic:!1};const a=['[class*="card"]','[class*="Card"]','[class*="item"]','[class*="Item"]','[class*="row"]','[class*="Row"]','[class*="list"]','[class*="List"]','[class*="grid"]','[class*="Grid"]','[role="listitem"]','[role="row"]','[role="gridcell"]'];for(const v of a){const d=e.closest(v);if(d){const h=d.parentElement;if(h&&Array.from(h.children).filter(T=>T!==d&&T.className===d.className).length>0)return{type:"api",source:"repeated container",isStatic:!1}}}if(e.closest("[v-for]")!==null||e.closest("[data-v-for]")!==null)return{type:"api",source:"loop item",isStatic:!1};if(e.parentElement){const v=e.parentElement,h=Array.from(v.children).filter(S=>S.tagName===e.tagName);if(h.length>=2&&h.filter(T=>T.children.length===e.children.length).length>=2)return{type:"api",source:"repeated element",isStatic:!1}}const m=[/^\d+$/,/^\d{4}[-/]\d{1,2}[-/]\d{1,2}/,/^\d{1,2}:\d{2}/,/^¥[\d,]+/,/^\$[\d,]+/,/^[\d,]+円$/,/^[a-f0-9]{8}-[a-f0-9]{4}/,/^[A-Z0-9]{6,}$/,/^\d+\.\d+$/,/^https?:\/\//,/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,/^\d+件$/,/^\d+個$/,/^第?\d+/];for(const v of m)if(v.test(n))return{type:"api",source:"dynamic data pattern",isStatic:!1};const u=[/^[\u4e00-\u9faf]{2,4}$/,/^[\u3040-\u309f\u30a0-\u30ff]{2,6}$/,/^[A-Z][a-z]+ [A-Z][a-z]+$/];for(const v of u)if(v.test(n))return{type:"api",source:"name pattern",isStatic:!1};const g=["LABEL","TH","LEGEND","FIGCAPTION"].includes(t),b=[/^(保存|キャンセル|閉じる|開く|編集|削除|追加|検索|送信|確認|戻る|次へ|完了|OK|Yes|No|Cancel|Save|Submit|Close|Open|Edit|Delete|Add|Search|Back|Next|Done)$/,/^[\u30a0-\u30ff]+$/,/項目$/,/一覧$/,/設定$/,/情報$/].some(v=>v.test(n)),A=t==="BUTTON"||e.closest("button")!==null||e.getAttribute("role")==="button";return g||b||A&&n.length<20?{type:"static",source:n.substring(0,50)+(n.length>50?"...":""),isStatic:!0}:n.length<=10&&/^[\u3040-\u30ff\u4e00-\u9faf]+$/.test(n)?{type:"prop",source:"short text (verify manually)",isStatic:!1}:n.length>0&&n.length<200?{type:"api",source:"content (assumed dynamic)",isStatic:!1}:null}function G(e,n){var y,b,A,N,v;const t={},o=((y=e.textContent)==null?void 0:y.trim())||"",s=e.getAttribute("data-di-binding");e.getAttribute("data-di-db"),e.getAttribute("data-di-component"),e.getAttribute("data-di-db-comment");let i=e;if(!s){const d=e.closest("[data-di-binding]");d&&(i=d)}const a=i.getAttribute("data-di-binding"),c=i.getAttribute("data-di-db"),m=i.getAttribute("data-di-component"),u=i.getAttribute("data-di-db-type"),l=i.getAttribute("data-di-db-comment");if(a||c){if(t.sourceBinding={type:"api",source:a||void 0,isStatic:!1},c){const[d,h]=c.split(".");d&&h&&(t.fieldInfo={table:d,column:h,type:u||void 0,description:l||void 0})}return m&&(t.devMeta={usedComponents:[m]}),t.note={type:"info",text:`【データバインディング】${a}${c?` → ${c}`:""}`},t}const g=K(e);if(g)if(t.sourceBinding=g,g.isStatic)t.note={type:"info",text:`【固定文言】${o}`};else if(g.type==="v-model"){const d=e.tagName.toUpperCase();if(d==="INPUT"||d==="SELECT"||d==="TEXTAREA"){const h=e.placeholder||"",S=((A=(b=e.closest("label"))==null?void 0:b.textContent)==null?void 0:A.trim())||e.getAttribute("aria-label")||((v=(N=document.querySelector(`label[for="${e.id}"]`))==null?void 0:N.textContent)==null?void 0:v.trim())||"";t.note={type:"todo",text:`【フォーム要素】${S||h||d.toLowerCase()}`}}}else g.type==="api"&&(t.note={type:"question",text:`【動的データ】${o.substring(0,100)}${o.length>100?"...":""}`});return t}const x=r.ref(!1),R=r.ref(0),_=r.ref([]);async function V(e={}){x.value=!0,R.value=0,_.value=[];const{rescan:n=!1}=e;if(n){const t=typeof window<"u"?window.location.pathname:"/",o=Object.keys(f.value).filter(s=>{const i=f.value[s];return!i.componentPath||i.componentPath.includes(t)});for(const s of o)delete f.value[s];r.nextTick(()=>U())}try{const t=["h1","h2","h3","h4","h5","h6","p","span","label","a","th","td","li","button","div","input","select","textarea",'[role="button"]','[role="link"]','[role="menuitem"]'].join(","),o=document.querySelectorAll(t),s=[];o.forEach(u=>{var d;const l=u;if(l.closest("[data-dev-inspector]"))return;const g=window.getComputedStyle(l);if(g.display==="none"||g.visibility==="hidden"||g.opacity==="0")return;const y=P(l);if(f.value[y])return;const b=l.tagName.toUpperCase(),A=((d=l.textContent)==null?void 0:d.trim())||"";if(b==="INPUT"||b==="SELECT"||b==="TEXTAREA"){s.push(l);return}if(A.length>300||A.length===0||b==="DIV"&&(Array.from(l.childNodes).filter(S=>S.nodeType===Node.TEXT_NODE).map(S=>{var T;return((T=S.textContent)==null?void 0:T.trim())||""}).join("").trim().length===0||l.children.length>3))return;const N=Array.from(l.childNodes).some(h=>{var S;return h.nodeType===Node.TEXT_NODE&&(((S=h.textContent)==null?void 0:S.trim())||"").length>0}),v=!Array.from(l.children).some(h=>["DIV","P","UL","OL","TABLE","SECTION","ARTICLE"].includes(h.tagName));(N||l.children.length===0&&A.length>0||v)&&s.push(l)});const i=s.length;let a=0,c=0;const m=20;for(let u=0;u<s.length;u+=m){const l=s.slice(u,u+m);for(const g of l){const y=P(g),b=G(g,y);b.sourceBinding&&(_.value.push({selector:y,element:g,detected:b}),Z(y,b),c++),a++,R.value=Math.round(a/i*100)}await new Promise(g=>setTimeout(g,10))}return c}finally{x.value=!1,R.value=100}}const Y=r.ref([]),z=r.ref("");async function Ae(e){var t;if(!e)return console.warn("[DevInspector] Router not provided for all pages scan"),[];x.value=!0;const n=[];try{const o=e.getRoutes(),s=[];for(const i of o)i.path.includes(":")&&!i.path.includes("?")||i.redirect||i.path!=="/:pathMatch(.*)*"&&((t=i.meta)!=null&&t.devInspectorSkip||s.push(i.path));Y.value=s;for(const i of s){z.value=i;try{await e.push(i),await new Promise(c=>setTimeout(c,500));const a=await V();n.push({page:i,count:a})}catch(a){console.warn(`[DevInspector] Failed to scan page ${i}:`,a),n.push({page:i,count:0})}}return n}finally{x.value=!1,z.value=""}}function Ee(){_.value=[],R.value=0}const C=r.ref([]);async function Q(){var i;if(!p.value)return console.warn("[DevInspector] No analysis data loaded. Call loadAnalysisData first."),0;C.value=[];const e=typeof window<"u"?window.location.pathname:"/",n=a=>{if(!p.value)return null;for(const[c,m]of Object.entries(p.value.components))if(m.componentName===a||m.componentName.toLowerCase()===a.toLowerCase()||c.toLowerCase().includes(`/${a.toLowerCase()}.vue`))return m;return null},t=(a,c=new Set)=>{const m=[];if(c.has(a.componentName))return m;if(c.add(a.componentName),m.push(...a.elements),a.usedComponents)for(const u of a.usedComponents){const l=n(u);l&&m.push(...t(l,c))}return m},o=[],s=new Set;for(const[a,c]of Object.entries(p.value.components)){const m=a.replace(/^pages/,"").replace(/\.vue$/,"").replace(/\/index$/,"").replace(/\[.*?\]/g,"[^/]+");let u=!1;if((e==="/"&&a.includes("index")||a.includes("pages/")&&e.match(new RegExp(`^${m}$`)))&&(u=!0),u){const l=t(c);o.push(...l),s.add(c.componentName),c.usedComponents&&c.usedComponents.forEach(g=>s.add(g))}}for(const[a,c]of Object.entries(p.value.components))a.includes("components/")&&!s.has(c.componentName)&&o.push(...c.elements);for(const a of o){if(E.value.has(a.selector))continue;let c=!1,m=a.selector;try{document.querySelector(a.selector)&&(c=!0)}catch{}if(!c&&a.text&&!a.binding){const u=a.text.replace(/\[コメント\]\s*/,""),l=document.createTreeWalker(document.body,NodeFilter.SHOW_TEXT,null);for(;l.nextNode();){const g=l.currentNode;if((i=g.textContent)!=null&&i.includes(u)){const y=g.parentElement;if(y){c=!0,m=P(y);break}}}}if(!c&&a.selector.includes(".")){const u=a.selector.match(/^(\w+)\.(.+)$/);if(u){const[,l,g]=u;try{const y=document.querySelector(a.selector);y&&(c=!0,m=P(y))}catch{}}}if(!c&&a.binding){const u=`[data-bind="${a.binding}"]`;try{const l=document.querySelector(u);l&&(c=!0,m=P(l))}catch{}}C.value.push({selector:m,element:a,matched:c})}return console.log(`[DevInspector] Applied analysis: ${C.value.filter(a=>a.matched).length}/${C.value.length} elements matched`),C.value.filter(a=>a.matched).length}function Ne(){C.value=[]}function Te(e){C.value=C.value.filter(n=>n.selector!==e),E.value.add(e),Le()}function Ie(){try{const e=localStorage.getItem(q);e&&(E.value=new Set(JSON.parse(e)))}catch{}}function Le(){try{localStorage.setItem(q,JSON.stringify([...E.value]))}catch{}}function Pe(){E.value.clear(),localStorage.removeItem(q)}function ee(){const e={removed:[...E.value],exportedAt:new Date().toISOString()};return JSON.stringify(e,null,2)}function $e(e="dev-inspector-changes.json"){const n=ee(),t=new Blob([n],{type:"application/json"}),o=URL.createObjectURL(t),s=document.createElement("a");s.href=o,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(o)}function te(){if(!p.value)return[];const e=[],n=new Set;for(const t of Object.values(p.value.components))for(const o of t.elements)o.binding&&!n.has(o.binding)&&(n.add(o.binding),e.push({binding:o.binding,db:o.db,api:o.api,component:t.componentName}));return e.sort((t,o)=>t.db&&!o.db?-1:!t.db&&o.db?1:t.binding.localeCompare(o.binding))}function Oe(e){const n=te();if(!e)return n;const t=e.toLowerCase();return n.filter(o=>{var s,i;return o.binding.toLowerCase().includes(t)||((s=o.db)==null?void 0:s.table.toLowerCase().includes(t))||((i=o.db)==null?void 0:i.column.toLowerCase().includes(t))||o.component.toLowerCase().includes(t)})}function ne(){var n,t;if(!((t=(n=p.value)==null?void 0:n.dbSchema)!=null&&t.tables))return[];const e=[];for(const[o,s]of Object.entries(p.value.dbSchema.tables))for(const[i,a]of Object.entries(s.columns))e.push({table:o,column:i,type:a.type,comment:a.comment,fullName:`${o}.${i}`});return e.sort((o,s)=>o.table!==s.table?o.table.localeCompare(s.table):o.column.localeCompare(s.column))}function De(e){const n=ne();if(!e)return n;const t=e.toLowerCase();return n.filter(o=>{var s;return o.table.toLowerCase().includes(t)||o.column.toLowerCase().includes(t)||o.fullName.toLowerCase().includes(t)||((s=o.comment)==null?void 0:s.toLowerCase().includes(t))})}function xe(){var t,o;const e=[],n=[];if(!((t=p.value)!=null&&t.components))return{pageLoad:e,action:n};for(const s of C.value){if(!s.matched)continue;const i=s.element.component;if(i&&((o=p.value.components[i])!=null&&o.apis))for(const a of p.value.components[i].apis)["onMount","useFetch","useAsyncData"].includes(a.loadTrigger)?e.some(c=>c.endpoint===a.endpoint&&c.method===a.method)||e.push(a):a.loadTrigger==="action"&&(n.some(c=>c.endpoint===a.endpoint&&c.method===a.method)||n.push(a))}return{pageLoad:e,action:n}}function Re(e){var n;if(!((n=p.value)!=null&&n.components))return null;for(const t of Object.values(p.value.components))if(t.apis){for(const o of t.apis)if(o.variable&&e.startsWith(o.variable))return o}return null}function je(e){L.value=e}function ke(){L.value=null}function Ue(){return JSON.stringify(f.value,null,2)}function oe(){const e={_meta:{version:"1.0.0",description:"Dev Inspector annotations",lastUpdated:new Date().toISOString()},annotations:f.value};return JSON.stringify(e,null,2)}function _e(e="dev-annotations.json"){const n=oe(),t=new Blob([n],{type:"application/json"}),o=URL.createObjectURL(t),s=document.createElement("a");s.href=o,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(o)}function Be(e){try{const n=JSON.parse(e),t=n.annotations||n;f.value={...f.value,...t}}catch(n){throw console.error("[DevInspector] Failed to import configs:",n),new Error("Invalid JSON format")}}function Fe(){f.value={}}return{isEnabled:I,isAvailable:k,isEditMode:w,isPickMode:O,isInitializing:B,hoveredSelector:F,currentScreenSpec:j,isPanelOpen:D,elementConfigs:f,editingElementId:L,init:ie,toggle:ue,enable:X,disable:de,toggleEditMode:fe,togglePickMode:pe,setHoveredSelector:me,generateSelector:P,getConfiguredSelectors:ge,setScreenSpec:ve,clearScreenSpec:he,togglePanel:ye,openPanel:be,closePanel:Se,getElementConfig:Ce,setElementConfig:Z,deleteElementConfig:we,startEditing:je,stopEditing:ke,exportConfigs:Ue,exportAsFile:oe,downloadAnnotations:_e,importConfigs:Be,clearAllConfigs:Fe,detectSourceBinding:K,autoDetectElementInfo:G,isScanning:x,scanProgress:R,scanResults:_,scanCurrentPage:V,scanAllPages:Ae,allPagesRoutes:Y,currentScanPage:z,clearScanResults:Ee,analysisData:p,loadAnalysisData:H,getAnalyzedElement:ce,getAnalyzedElementsForPage:le,analysisResults:C,applyAnalysisToPage:Q,clearAnalysisResults:Ne,removeAnalysisResult:Te,clearHiddenSelectors:Pe,hiddenAnalysisSelectors:E,analysisFilter:se,exportChangesForCli:ee,downloadChanges:$e,getAvailableBindings:te,searchBindings:Oe,getSchemaColumns:ne,searchSchemaColumns:De,getCurrentPageApis:xe,getApiSourceForBinding:Re}});function Me(){return ae()}exports.useDevInspector=Me;exports.useDevInspectorStore=ae;
